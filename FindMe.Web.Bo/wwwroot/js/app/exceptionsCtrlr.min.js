(function(){"use strict";function n(n,t,i,r,u){var h,f,c,s,e,o;$("[data-toggle=tooltip]").tooltip({trigger:"hover"});u.reset();u.title=r.lbl_Exceptions;u.showToolBar=!1;u.showSearchCtrl=!0;u.showSaveBtn=!1;u.addBtnTltp=r.msg_AddAddrException;u.refreshBtnTltp=r.msg_RfrshAddrExceptions;u.saveBtnTltp=r.msg_SaveAddrExceptions;h=5;f=this;f.appProps=r;f.pgsCollection=[];f.currentPgNmbr=0;f.totalPgs=0;f.skipFilesVerification=!1;f.reverseVerify=!1;f.gotoPage=function(n,t){!n||n.isActive||n.disabled||(t,c(n.index)&&(f.currentPgNmbr=n.index,$.each(f.pgsCollection,function(){this.isActive=n===this})))};c=function(n){var u=r.resultItemsPerPg*n,t,i;if(f.addrExceptions.length>u){for(f.addrExceptionsPage.length=0,t=u+r.resultItemsPerPg,f.addrExceptions.length<=t&&(t=f.addrExceptions.length),i=u;i<t;i++)f.addrExceptionsPage.push(f.addrExceptions[i]);return!0}return!1};s=function(){var n,t,i;if(f.pgsCollection.length=0,f.totalPgs>1){for(n=f.currentPgNmbr-2,t=f.currentPgNmbr+2,n<0&&(t+=0-n,n=0),t>=f.totalPgs&&(t=f.totalPgs-1);t-n<4;)n--;for(n=n<0?0:n,f.pgsCollection.push({index:0,isActive:!1,text:"",icon:"fa fa-step-backward",disabled:f.currentPgNmbr<=0}),i=n;i<=t;i++)f.pgsCollection.push({index:i,isActive:f.currentPgNmbr===i,text:String(i+1),icon:"",disabled:!1});f.pgsCollection.push({index:f.totalPgs-1,isActive:!1,text:"",icon:"fa fa-step-forward",disabled:f.currentPgNmbr>=f.totalPgs-1})}};f.addrIDsCount=0;f.addrExceptions=[];f.addrExceptionsPage=[];o=[];f.hideWarning=!1;f.gettingAddressesCount=!1;f.verifyingAddresses=!1;f.cancelVerification=!1;f.getAddressesCountMessage=function(){return f.appProps.msg_LkngExptnsTime.replace("{0}",f.addrIDsCount)};f.verifiedAddrs=0;f.getVerifyAddrMessage=function(){return f.appProps.msg_ExAddrVrfd.replace("{0}",f.verifiedAddrs).replace("{1}",f.addrIDsCount)};f.getAllAddressIDs=function(){f.showError=!1;f.errorstatus="";f.errormsg="";f.errorid=0;var t=function(n){f.addrIDsCount=0;n.data&&n.data.result&&(e=n.data.result,f.addrIDsCount=e.length)},i=function(n){n.data&&checkRedirectForSignIn(n.data)&&(f.errorstatus=n.status+" - "+n.statusText,f.errormsg=n.data.msg,f.errorid=n.data.id,f.showError=!0)},u=function(){f.gettingAddressesCount=!1};f.gettingAddressesCount=!0;n.get(r.urlGetAllAddressIDs).then(t,i).finally(u)};var l=!1,a=0,v=function(t){var u,i,e;if(t&&t.raw&&t.raw.status===30&&t.data&&t.data.length>0){for(t.isGeneneratingThumbnail=!0,u=0;u<t.data.length;u++)i=t.data[u],i.isGeneneratingThumbnail=!0,o.push({id:i.file.id,format:i.file.format,dimensions:i.th,af:i,ex:t,uid:++a});e=function(){for(var t,i=[],c=[],l=function(n){var t=n&&n.data&&n.data.errors&&n.data.errors.length>0;$.each(i,function(i,r){var u=t?$.grep(n.data.errors,function(n){return parseInt(n.uid)===r.uid}):null;u=u&&u.length>0?u[0].error:null;u?(r.af.thumbnailGenerationFailed=!0,r.af.isGeneneratingThumbnail=!1,r.af.genErrorMsg=u):(r.af.isGeneneratingThumbnail=!1,r.ex.data.remove(r.af));r.ex.data.length===0?(f.addrExceptions.remove(r.ex),f.addrExceptionsPage.remove(r.ex),s()):$.grep(r.ex.data,function(n){return n.isGeneneratingThumbnail}).length===0&&(r.ex.isGeneneratingThumbnail=!1,r.ex.thumbnailGenerationFailed=!0)})},a=function(){$.each(i,function(n,t){t.af.thumbnailGenerationFailed=!0;t.af.isGeneneratingThumbnail=!1})},v=function(){$.each(i,function(n,t){o.remove(t)});o.length>0&&e()},u=0;u<h;u++)u<o.length&&(t=o[u],i.push(t),c.push({addrFileID:t.id,addrFileFormat:t.format,dimensions:t.dimensions,uid:t.uid,optimizedMedia:!0}));n.post(r.urlGenerateAddressFile,{params:c}).then(l,a).finally(v)};l||e()}},y=function(n){var t,i;if(n){t="";switch(n.status){case 10:t="File Missing";break;case 11:t="Optimized File Missing";break;case 20:t="Invalid File";break;case 21:t="Invalid Optimized File";break;case 30:t="Thumbnail Missing";break;case 40:t="Invalid Thumbnail";break;case 50:t="Multiple Slugs";break;case 60:t="Invalid City";break;case 70:t="Invalid Category"}return i={name:n.name,slug:n.slug,status:t,showMsgs:!1},i.data=n.data,delete n.data,i.raw=n,i.data&&i.data.length>0&&$.each(i.data,function(){switch(n.status){case 10:case 20:case 30:case 40:this.msg="File [ "+(n.status===30||n.status===40?"Dimension: "+this.th+" | ":"")+"Name: "+(this.file.name?this.file.name:"<NONE>")+" | UID: "+this.file.uid+" | Type: "+this.type+" | Format: "+this.file.format+" ]";break;case 50:this.msg=this.addSlugsCount+" more Address(es) use this Slug"}}),i}return n};f.verifyAddresses=function(t){var i,c,u,h;if(f.hideWarning=!0,t||(t=f.reverseVerify?e.length-1:0),i=f.skipFilesVerification?10:1,(f.reverseVerify&&t===e.length-1||!f.reverseVerify&&t===0)&&(f.verifiedAddrs=0,f.addrExceptions.length=0,f.addrExceptionsPage.length=0,f.cancelVerification=!1,o.length=0),f.cancelVerification||!e||t<0||t>=e.length)f.cancelVerification=!1,f.verifyingAddresses=!1;else{f.showError=!1;f.errorstatus="";f.errormsg="";f.errorid=0;var l=function(n){f.verifiedAddrs+=i;n.data&&n.data.exceptions&&$.each(n.data.exceptions,function(){var n=y(this);f.addrExceptions.push(n);f.addrExceptionsPage.length<r.resultItemsPerPg&&f.addrExceptionsPage.push(n);v(n)})},a=function(n){if(f.verifiedAddrs+=i,n.data&&checkRedirectForSignIn(n.data)){var t={hasError:!0,status:n.status,msg:n.data.msg,id:n.data.id};f.addrExceptions.push(t);f.addrExceptionsPage.length<r.resultItemsPerPg&&f.addrExceptionsPage.push(t)}},p=function(){var n=parseInt(f.addrExceptions.length/r.resultItemsPerPg);n+=f.addrExceptions.length%r.resultItemsPerPg>0?1:0;f.totalPgs=n;f.verifyAddresses(f.reverseVerify?t-i:t+i);s()};for(f.verifyingAddresses=!0,c=[],u=0;u<i;u++)h=f.reverseVerify?t-u:u+t,h>=0&&h<e.length&&c.push({addrID:e[h],addrUID:null});n.post(r.urlVerifyAddress,{addresses:c,skipFilesVerification:f.skipFilesVerification}).then(l,a).finally(p)}};$("#searchBar").on("searchGo",function(n,i){i&&i.searchValue&&t.$apply(function(){f.searchValue=i.searchValue;f.populateAddrExceptions(r.resultItemsPerPg,0,i.searchValue)})});$("#searchBar").on("searchClear",function(){t.$apply(function(){f.searchValue="";f.populateAddrExceptions(r.resultItemsPerPg,0)})})}angular.module("app-mainmenu").controller("exceptionsCtrlr",["$http","$scope","$uibModal","appProps","headerConfigService",n])})();