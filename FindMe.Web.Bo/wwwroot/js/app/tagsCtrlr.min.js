(function(){"use strict";function n(n,t,i,r,u,f,e){var o,h;$("[data-toggle=tooltip]").tooltip({trigger:"hover"});e.reset();e.title=r.lbl_Tags;e.showToolBar=!0;e.showSearchCtrl=!0;e.showSaveBtn=!1;e.addBtnTltp=r.msg_AddTag;e.refreshBtnTltp=r.msg_RfrshTags;e.saveBtnTltp=r.msg_SaveTags;o=this;o.appProps=r;o.pgsCollection=[];o.currentPgNmbr=0;o.totalPgs=0;o.tagsCount=0;o.tagsCountMod=0;o.tags=[];o.gotoPage=function(n,t){if(n&&!n.isActive&&!n.disabled){t;var i=r.resultItemsPerPg*n.index-1;i=i<0?0:i;o.currentPgNmbr=n.index;o.populateTags(r.resultItemsPerPg,i)}};o.deleteModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"deleteTagModal.html",controller:"deleteTagInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#tagsVw .modal-container"),resolve:{param:function(){return{tag:n,save:o.save}}}})};o.openModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"tagModal.html",controller:"tagInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#tagsVw .modal-container"),resolve:{tag:function(){return jQuery.extend(!0,{},n)}}})};o.goInEditMode=function(n,t){if(t&&(t.inEditMode=!0,n&&n.currentTarget)){var i=$(n.currentTarget).parents("tr").first();i&&i.length>0&&$("textarea[elastic]",i).trigger("input")}};var c=function(){var n,t,i;if(o.pgsCollection.length=0,o.totalPgs>1){for(n=o.currentPgNmbr-2,t=o.currentPgNmbr+2,n<0&&(t+=0-n,n=0),t>=o.totalPgs&&(t=o.totalPgs-1);t-n<4;)n--;for(n=n<0?0:n,o.pgsCollection.push({index:0,isActive:!1,text:"",icon:"fa fa-step-backward",disabled:o.currentPgNmbr<=0}),i=n;i<=t;i++)o.pgsCollection.push({index:i,isActive:o.currentPgNmbr===i,text:String(i+1),icon:"",disabled:!1});o.pgsCollection.push({index:o.totalPgs-1,isActive:!1,text:"",icon:"fa fa-step-forward",disabled:o.currentPgNmbr>=o.totalPgs-1})}},l=function(n,t,i){n&&t&&(n.recordState=n.id>0?i?30:n.name_en!==t.name_en||n.name_fr!==t.name_fr||n.slug_en!==t.slug_en||n.slug_fr!==t.slug_fr||n.active!==t.active?20:0:10)},s="";o.populateTags=function(t,i,u){var f=!1;u=u?u:o.searchValue;(u||s)&&(f=u!==s);s=u;f=f||o.tagsCountMod!==0;o.showError=!1;o.errorstatus="";o.errormsg="";o.errorid=0;t=t?t:r.resultItemsPerPg;i=i?i:0;var e=function(n){var u,i,t;if(o.tags.length=0,n.data&&((n.data.count>0||n.data.count===0&&n.data.result&&n.data.result.length===0)&&(o.tagsCountMod=0,o.tagsCount=n.data.count,u=parseInt(o.tagsCount/r.resultItemsPerPg),u+=o.tagsCount%r.resultItemsPerPg>0?1:0,o.totalPgs=u),c(),n.data.result))for(i=0;i<n.data.result.length;i++)t=n.data.result[i],t.name=r.currentLang.startsWith("en")?t.name_en:t.name_fr,t.__comp=jQuery.extend(!0,{},t),o.tags.push(t),t.inEditMode=!1,t.saving=!1},h=function(n){n.data&&checkRedirectForSignIn(n.data)&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},l=function(){toggleGlblWaitVisibility(!1)};toggleGlblWaitVisibility(!0);n.post(r.urlGetTags,{limit:t,offset:i,getTotalTags:o.tagsCount<=0||f,name:u?u:null}).then(e,h).finally(l)};o.revert=function(n){if(n&&n.__comp)if(n.id>0){var t=n.__comp;n.name_en=t.name_en;n.name_fr=t.name_fr;n.slug_en=t.slug_en;n.slug_fr=t.slug_fr;n.active=t.active;n.inEditMode=!1}else o.tags.remove(n)};o.initFrm=function(n){n&&u.setItemFormValidation(n,[{name:"name_en",isReq:!0},{name:"name_fr",isReq:!0},{name:"slug_en",isReq:!0},{name:"slug_fr",isReq:!0}])};o.slugify=function(n,t){if(n&&t)switch(t.toLowerCase()){case"name_en":case"en":n.slug_en||(n.slug_en=f.slugify(n.name_en));break;case"name_fr":case"fr":n.slug_fr||(n.slug_fr=f.slugify(n.name_fr))}};o.save=function(t,i,f){var h,s,c;if(t&&(Array.isArray(t)||(t=[t]),u.isFormValArrayValid(t))){f&&!Array.isArray(f)&&(f=[f]);var e=[],a=[],v=f&&f.length===t.length;for(h=0;h<t.length;h++)s=t[h],s&&s.__comp&&(c=jQuery.extend(!0,{},s),delete c.__comp,l(c,s.__comp,v?f[h]:!1),a.push(c),s.saving=!0,e.push(s));if(e.length>0){var y=function(n){n.data&&n.data.result&&n.data.result.length>0&&e.length===n.data.result.length&&$.each(n.data.result,function(n,t){var i=e[n];t?(i.id=t.id,i.name_en=t.name_en,i.name_fr=t.name_fr,i.slug_en=t.slug_en,i.slug_fr=t.slug_fr,i.active=t.active,s.name=r.currentLang.startsWith("en")?s.name_en:s.name_fr,a[n].recordState===10&&(o.tagsCountMod+=1,(!o.totalPgs||o.totalPgs<=0)&&(o.totalPgs=1)),delete i.status,delete i.recordState,i.__comp=t):(o.tags.remove(i),o.tagsCountMod-=1,o.tagsCount+o.tagsCountMod<=0&&(o.totalPgs=0))});for(var t=0;t<e.length;t++)e[t].saving=!1,e[t].inEditMode=!1},p=function(n){for(var t=0;t<e.length;t++)e[t].saving=!1,e[t].inEditMode=!0;n.data&&checkRedirectForSignIn(n.data)&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},w=function(){i&&i()};o.showError=!1;o.errorstatus="";o.errormsg="";o.errorid=0;n.post(r.urlSaveTags,{tags:a}).then(y,p).finally(w)}}};h=function(){var i=$(this),n,u;i.hasClass("refresh")?(n=$.grep(o.pgsCollection,function(n){return n.isActive}),n&&Array.isArray(n)&&(n=n.length>0?n[0]:null),n&&(u=r.resultItemsPerPg*n.index-1,t.$apply(function(){o.populateTags(r.resultItemsPerPg,u)}))):i.hasClass("add")&&t.$apply(function(){var n={id:0,name_en:null,name_fr:null,slug_en:null,slug_fr:null,active:!0};n.__comp=jQuery.extend(!0,{},n);n.inEditMode=!0;n.saving=!1;o.tags.insert(0,n)})};$("#searchBar .btn.btn-tb").on("click",h);$("#searchBar").on("searchGo",function(n,i){i&&i.searchValue&&t.$apply(function(){o.searchValue=i.searchValue;o.populateTags(r.resultItemsPerPg,0,i.searchValue)})});$("#searchBar").on("searchClear",function(){t.$apply(function(){o.searchValue="";o.populateTags(r.resultItemsPerPg,0)})})}function t(n,t,i){var r=this;r.appProps=t;r.tag=i.tag;r.yes=function(){n.close(r.tag);$("#glblWait").removeClass("hidden");i.save(i.tag,function(){$("#glblWait").addClass("hidden")},!0)};r.no=function(){n.close()}}angular.module("app-mainmenu").controller("tagsCtrlr",["$http","$scope","$uibModal","appProps","listItemService","miscToolsService","headerConfigService",n]);angular.module("app-mainmenu").controller("deleteTagInstanceCtrlr",["$uibModalInstance","appProps","param",t])})();