(function(){"use strict";function n(n,t,i,r,u,f,e){var o,a,s,l,h,c;$("[data-toggle=tooltip]").tooltip({trigger:"hover"});u.reset();u.title=r.lbl_Import;u.showToolBar=!1;u.showSearchCtrl=!1;u.showSaveBtn=!1;u.addBtnTltp=r.msg_AddClnts;u.refreshBtnTltp=r.msg_RfrshClnts;u.saveBtnTltp=r.msg_SaveClnts;o=this;o.appProps=r;o.showUpload=!0;o.showClear=!1;o.showTable=!1;o.showError=!1;o.hasFile=!1;o.hasSuccess=!1;o.csvItems=[];o.tableHeaders=[];o.categories=[];o.categoryErrorsCount=0;o.showDbValErrors=!1;o.errorCount=0;o.errorstatus="";o.errormsg="";o.errorid=0;o.addrFilename="";o.timeFilename="";o.log={text:""};a=$("#csv");s=document.getElementById("csv-table").getElementsByTagName("tbody")[0].getElementsByTagName("tr");o.browseGo=function(n){n&&$("#"+n).click()};l=function(n){n&&(n.addressName=n.addressName?n.addressName.encodeHtml():n.addressName)};o.uploadCSvForm=function(){var t,i;if(o.categoryErrorsCount=0,t=$("#addrCSV").get(0),t&&t.files.length===1){i=new FormData;i.append("ADDR_CSV",t.files[0]);t=$("#timeCSV").get(0);t&&t.files.length===1&&i.append("TIME_CSV",t.files[0]);var r=function(n){var i,r,u,t,f,s,e;if(n&&n.data)if(n.data.error)o.showUpload=!1,o.showClear=!0,o.showTable=!0,o.errormsg=n.data.error;else if(n.data.addresses){for(t=0;t<n.data.processedCsvCatgs.length;t++)if(i=n.data.processedCsvCatgs[t],i&&(o.categories.push(i),o.categoryErrorsCount+=i.foundInDb?0:1,i.showSubCatgs=!0,i.subCategories))for(r=0;r<i.subCategories.length;r++)u=i.subCategories[r],u.parentUID=i.uid,u.parentName=i.name,o.categoryErrorsCount+=u.foundInDb?0:1;for(t=0;t<n.data.addresses.length;t++){if(f=n.data.addresses[t],t===0)for(s in f)s.startsWith("_")||o.tableHeaders.push(s);l(f);o.csvItems.push(f)}for(e=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<e.length;t++)e[t]===null?o.hasSuccess=!0:(o.errorCount++,o.log.text=e[t]);o.showUpload=!1;o.showClear=!0;o.showTable=!0}},u=function(n){n.data&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},f=function(){toggleGlblWaitVisibility(!1)};o.errormsg="";o.csvItems.length=0;o.tableHeaders.length=0;o.errorCount=0;toggleGlblWaitVisibility(!0);n({url:"/ApiBulkImport/UploadCSV",method:"POST",data:i,headers:{"Content-Type":undefined},transformRequest:angular.identity}).then(r,u).finally(f)}};h=document.getElementById("addrCSV");h.onchange=function(){t.$apply(function(){o.addrFilename=h.files[0].name})};c=document.getElementById("timeCSV");c.onchange=function(){t.$apply(function(){o.timeFilename=c.files[0].name})};o.clearForm=function(){o.hasSuccess=!1;o.showTable=!1;o.showClear=!1;o.showUpload=!0;o.showDbValErrors=!1;o.addrFilename="";o.timeFilename="";h.value="";c.value="";o.csvItems.length=0;o.tableHeaders.length=0;o.categories.length=0;o.categoryErrorsCount=0};o.showAll=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!1:!1};o.showAllSuccess=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!1:!0};o.showAllErrors=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!0:!1};o.download=function(n){var t=new e([n],{type:"text/plain;charset=utf-8"});f.saveAs(t,"log.txt")};o.createCatgModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createCategoryModal.html",controller:"createCategoryInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{category:n,rootVm:o}}}})}}function t(n,t,i,r){var u=this;u.appProps=i;u.category={name:r.category.name,slug:r.category.slug,parentUID:r.category.parentUID,parentName:r.category.parentName,name_en:r.category.name,name_fr:"",slug_en:r.category.slug,slug_fr:"",iconClass:"",id:0,parent_Id:null,level:0,path:"",active:!0,status:1,recordState:10,desc_en:"",desc_fr:""};u.save=function(){var f=!1,e=function(n){var t,u,e;if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1&&(t=n.data.result[0],r.category.uid=t.uid,r.category.foundInDb=!0,r.category.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr,r.rootVm.categoryErrorsCount--,r.category.subCategories))for(u=0;u<r.category.subCategories.length;u++)e=r.category.subCategories[u],e.parentUID=r.category.uid,e.parentName=r.category.name},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveCatgs,{catgs:[u.category]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}angular.module("app-mainmenu").controller("bulkImportCtrlr",["$http","$scope","$uibModal","appProps","headerConfigService","FileSaver","Blob",n]);angular.module("app-mainmenu").controller("createCategoryInstanceCtrlr",["$http","$uibModalInstance","appProps","param",t])})();