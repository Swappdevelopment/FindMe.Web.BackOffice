(function(){"use strict";function n(n,t,i,r,u,f,e){var o,a,s,l,v,h,c;$("[data-toggle=tooltip]").tooltip({trigger:"hover"});u.reset();u.title=r.lbl_Import;u.showToolBar=!1;u.showSearchCtrl=!1;u.showSaveBtn=!1;u.addBtnTltp=r.msg_AddClnts;u.refreshBtnTltp=r.msg_RfrshClnts;u.saveBtnTltp=r.msg_SaveClnts;o=this;o.appProps=r;o.showUpload=!0;o.showClear=!1;o.showTable=!1;o.showError=!1;o.hasFile=!1;o.hasSuccess=!1;o.csvItems=[];o.tableHeaders=[];o.categories=[];o.subCategories=[];o.categoryErrorsCount=0;o.tags=[];o.tagErrorsCount=0;o.cityDetails=[];o.cityDetailErrorsCount=0;o.showCatgDbValErrors=!1;o.showTagDbValErrors=!1;o.showCityDetailDbValErrors=!1;o.errorCount=0;o.errorstatus="";o.errormsg="";o.errorid=0;o.addrFilename="";o.timeFilename="";o.log={row:""};a=$("#csv");s=document.getElementById("csv-table").getElementsByTagName("tbody")[0].getElementsByTagName("tr");o.browseGo=function(n){n&&$("#"+n).click()};l=function(n){n&&(n.addressName=n.addressName?n.addressName.encodeHtml():n.addressName)};v=function(n){if(n){if(n.errorMessage||n._linkParentCatg&&!n._linkParentCatg.foundInDb||n._linkCatg&&!n._linkCatg.foundInDb||n._linkCityDetail&&!n._linkCityDetail.foundInDb)return!0;if(n._linkTags&&!n._linkTags.length>0)return n._linkParentCatg=$.grep(n._linkTags,function(n){return!n.foundInDb})>0}return!1};o.uploadCSvForm=function(){var t,i;if(o.categoryErrorsCount=0,t=$("#addrCSV").get(0),t&&t.files.length===1){i=new FormData;i.append("ADDR_CSV",t.files[0]);t=$("#timeCSV").get(0);t&&t.files.length===1&&i.append("TIME_CSV",t.files[0]);var r=function(n){var i,r,u,f,e,s,t,h;if(n&&n.data)if(n.data.error)o.showUpload=!1,o.showClear=!0,o.showTable=!0,o.errormsg=n.data.error;else if(n.data.addresses){for(i=0;i<n.data.processedCsvCatgs.length;i++)if(r=n.data.processedCsvCatgs[i],r&&(o.categories.push(r),o.categoryErrorsCount+=r.foundInDb?0:1,r.showSubCatgs=!0,r.subCategories))for(u=0;u<r.subCategories.length;u++)f=r.subCategories[u],f.parentUID=r.uid,f.parentName=r.name,o.categoryErrorsCount+=f.foundInDb?0:1;for(i=0;i<n.data.processedCsvTags.length;i++)e=n.data.processedCsvTags[i],e&&(o.tags.push(e),o.tagErrorsCount+=e.foundInDb?0:1);for(i=0;i<n.data.processedCsvCityDetails.length;i++)s=n.data.processedCsvCityDetails[i],s&&(o.cityDetails.push(s),o.cityDetailErrorsCount+=s.foundInDb?0:1);for(i=0;i<n.data.addresses.length;i++){if(t=n.data.addresses[i],t._linkParentCatg=$.grep(o.categories,function(n){return n.index===t._ParentCatgIndex}),Array.isArray(t._linkParentCatg)&&(t._linkParentCatg=t._linkParentCatg.length>0?t._linkParentCatg[0]:null),t._linkCatg=t._linkParentCatg?$.grep(t._linkParentCatg.subCategories,function(n){return n.index===t._CatgIndex}):$.grep(o.categories,function(n){return n.index===t._CatgIndex}),Array.isArray(t._linkCatg)&&(t._linkCatg=t._linkCatg.length>0?t._linkCatg[0]:null),t._linkTags=t._TagsIndexes&&t._TagsIndexes.length>0?$.grep(o.tags,function(n){return $.inArray(n.index,t._TagsIndexes)>=0}):[],t._linkCityDetail=$.grep(o.cityDetails,function(n){return n.index===t._CityDetailIndex}),Array.isArray(t._linkCityDetail)&&(t._linkCityDetail=t._linkCityDetail.length>0?t._linkCityDetail[0]:null),i===0)for(h in t)h.startsWith("_")||o.tableHeaders.push(h);l(t);o.csvItems.push(t)}o.showUpload=!1;o.showClear=!0;o.showTable=!0}},u=function(n){n.data&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},f=function(){toggleGlblWaitVisibility(!1)};o.errormsg="";o.csvItems.length=0;o.tableHeaders.length=0;o.errorCount=0;toggleGlblWaitVisibility(!0);n({url:"/ApiBulkImport/UploadCSV",method:"POST",data:i,headers:{"Content-Type":undefined},transformRequest:angular.identity}).then(r,u).finally(f)}};h=document.getElementById("addrCSV");h.onchange=function(){o.addrFilename=h.files[0].name;t.$$phase||t.$apply()};c=document.getElementById("timeCSV");c.onchange=function(){o.timeFilename=c.files[0].name;t.$$phase||t.$apply()};o.clearForm=function(){o.hasSuccess=!1;o.showTable=!1;o.showClear=!1;o.showUpload=!0;o.showCatgDbValErrors=!1;o.showTagDbValErrors=!1;o.showCityDetailDbValErrors=!1;o.addrFilename="";o.timeFilename="";h.value="";c.value="";o.csvItems.length=0;o.tableHeaders.length=0;o.categories.length=0;o.categoryErrorsCount=0};o.showAll=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!1:!1};o.showAllSuccess=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!1:!0};o.showAllErrors=function(){for(var n,r,i=o.csvItems.map(function(n){return n.errorMessage}),t=0;t<i.length;t++)for(n=0;n<s.length;n++)r=s[n],r.hidden=i[t]===null?!0:!1};o.download=function(){$.each(o.csvItems,function(n,t){t.errorMessage?o.log.row+=t.errorMessage+"\r\n\r\n":(t._linkParentCatg&&!t._linkParentCatg.foundInDb&&(o.log.row+="Error caught for Row "+(n+1)+":\r\n",o.log.row+="The Category '"+t._linkParentCatg.name+"' does not exist in the database.\r\n",t._linkCatg&&!t._linkCatg.foundInDb&&(o.log.row+="The Sub Category '"+t._linkCatg.name+"' does not exist in the database.\r\n\r\n")),t._linkCatg&&!t._linkCatg.foundInDb&&(o.log.row+="The Sub Category '"+t._linkCatg.name+"' does not exist in the database.\r\n\r\n"))});var n=new e([o.log.row],{type:"text/plain;charset=utf-8"});f.saveAs(n,"log.txt")};o.createCatgModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createCategoryModal.html",controller:"createCategoryInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{category:n,rootVm:o}}}})};o.createTagModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createTagModal.html",controller:"createTagInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{tag:n,rootVm:o}}}})};o.createCityDetailModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createCityDetailModal.html",controller:"createCityDetailInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{cityDetail:n,rootVm:o}}}})}}function t(n,t,i,r){var u=this;u.appProps=i;u.category={name:r.category.name,slug:r.category.slug,parentUID:r.category.parentUID,parentName:r.category.parentName,name_en:r.category.name,name_fr:"",slug_en:r.category.slug,slug_fr:"",iconClass:"",id:0,parent_Id:null,level:0,path:"",active:!0,status:1,recordState:10,desc_en:"",desc_fr:""};u.save=function(){var f=!1,e=function(n){var t,u,e;if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1&&(t=n.data.result[0],r.category.uid=t.uid,r.category.foundInDb=!0,r.category.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr,r.rootVm.categoryErrorsCount--,r.category.subCategories))for(u=0;u<r.category.subCategories.length;u++)e=r.category.subCategories[u],e.parentUID=r.category.uid,e.parentName=r.category.name},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveCatgs,{catgs:[u.category]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}function i(n,t,i,r){var u=this;u.appProps=i;u.tag={name:r.tag.name,slug:r.tag.slug,name_en:r.tag.name,name_fr:"",slug_en:r.tag.slug,slug_fr:"",id:0,active:!0,status:1,recordState:10};u.save=function(){var f=!1,e=function(n){if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1){var t=n.data.result[0];r.tag.uid=t.uid;r.tag.foundInDb=!0;r.tag.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr;r.rootVm.tagErrorsCount--}},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveTags,{tags:[u.tag]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}function r(n,t,i,r){var u=this;u.appProps=i;u.cityDetail={name:r.cityDetail.name,slug:r.cityDetail.slug,name_en:r.cityDetail.name,name_fr:"",slug_en:r.cityDetail.slug,slug_fr:"",region_Id:r.cityDetail.region_Id,district_Id:r.cityDetail.region_Id,group_Id:r.cityDetail.region_Id,id:0,active:!0,status:1,recordState:10};u.save=function(){var f=!1,e=function(n){if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1){var t=n.data.result[0];r.cityDetail.uid=t.uid;r.cityDetail.foundInDb=!0;r.cityDetail.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr;r.cityDetail.region_Id=t.region_Id;r.cityDetail.district_Id=t.district_Id;r.cityDetail.group_Id=t.group_Id;r.rootVm.cityDetailErrorsCount--}},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveCityDetails,{cityDetails:[u.cityDetail]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}angular.module("app-mainmenu").controller("bulkImportCtrlr",["$http","$scope","$uibModal","appProps","headerConfigService","FileSaver","Blob",n]);angular.module("app-mainmenu").controller("createCategoryInstanceCtrlr",["$http","$uibModalInstance","appProps","param",t]);angular.module("app-mainmenu").controller("createTagInstanceCtrlr",["$http","$uibModalInstance","appProps","param",i]);angular.module("app-mainmenu").controller("createCityDetailInstanceCtrlr",["$http","$uibModalInstance","appProps","param",r])})();