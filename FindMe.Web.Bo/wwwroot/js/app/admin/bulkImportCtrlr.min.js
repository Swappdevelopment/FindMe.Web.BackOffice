(function(){"use strict";function n(n,t,i,r,u,f,e){var o,a,v,l,s,h,c;$("[data-toggle=tooltip]").tooltip({trigger:"hover"});u.reset();u.title=r.lbl_Import;u.showToolBar=!1;u.showSearchCtrl=!1;u.showSaveBtn=!1;u.addBtnTltp=r.msg_AddClnts;u.refreshBtnTltp=r.msg_RfrshClnts;u.saveBtnTltp=r.msg_SaveClnts;o=this;o.appProps=r;o.showUpload=!0;o.showClear=!1;o.showTable=!1;o.showError=!1;o.hasFile=!1;o.Errors=!1;o.CsvErrors=!1;o.hasSuccess=!1;o.cityRegions=[];o.cityDistricts=[];o.cityGroups=[];o.postSaveLogs=[];o.csvItems=[];o.tableHeaders=[];o.categories=[];o.subCategories=[];o.categoryErrorsCount=0;o.tags=[];o.tagErrorsCount=0;o.cityDetails=[];o.cityDetailErrorsCount=0;o.showCatgDbValErrors=!1;o.showTagDbValErrors=!1;o.showCityDetailDbValErrors=!1;o.showPostSaveErrors=!1;o.errorCount=0;o.errorstatus="";o.errormsg="";o.errorid=0;o.addrFilename="";o.timeFilename="";o.log={row:""};a=$("#csv");v=document.getElementById("csv-table").getElementsByTagName("tbody")[0].getElementsByTagName("tr");o.browseGo=function(n){n&&$("#"+n).click()};l=function(n){n&&(n.addressName=n.addressName?n.addressName.encodeHtml():n.addressName)};s=function(n,t){if(n){if(n.hasPostSaveError&&!t||n.errorMessage||n._linkParentCatg&&!n._linkParentCatg.foundInDb||n._linkCatg&&!n._linkCatg.foundInDb||n._linkCityDetail&&!n._linkCityDetail.foundInDb)return!0;if(n._linkTags&&n._linkTags.length>0)return $.grep(n._linkTags,function(n){return!n.foundInDb})>0;if(n._DaysCsv&&n._DaysCsv.length>0)return $.grep(n._DaysCsv,function(n){return n.errorMessage&&n.errorMessage.length>0})>0}return!1};o.uploadCSvForm=function(){var t,i;if(o.categoryErrorsCount=0,t=$("#addrCSV").get(0),t&&t.files.length===1){i=new FormData;i.append("ADDR_CSV",t.files[0]);t=$("#timeCSV").get(0);t&&t.files.length===1&&i.append("TIME_CSV",t.files[0]);var r=function(n){var r,u,f,e,h,t,c,a,i,v;if(n&&n.data)if(n.data.error)o.showUpload=!1,o.showClear=!0,o.showTable=!0,o.errormsg=n.data.error;else if(n.data.addresses){for(i=0;i<n.data.processedCsvCatgs.length;i++)if(r=n.data.processedCsvCatgs[i],r&&(o.categories.push(r),o.categoryErrorsCount+=r.foundInDb?0:1,r.showSubCatgs=!0,r.subCategories))for(u=0;u<r.subCategories.length;u++)f=r.subCategories[u],f.parentUID=r.uid,f.parentName=r.name,o.categoryErrorsCount+=f.foundInDb?0:1;for(i=0;i<n.data.processedCsvTags.length;i++)e=n.data.processedCsvTags[i],e&&(o.tags.push(e),o.tagErrorsCount+=e.foundInDb?0:1);for(i=0;i<n.data.processedCsvCityDetails.length;i++)h=n.data.processedCsvCityDetails[i],h&&(o.cityDetails.push(h),o.cityDetailErrorsCount+=h.foundInDb?0:1);for(i=0;i<n.data.addresses.length;i++){if(t=n.data.addresses[i],t._linkParentCatg=$.grep(o.categories,function(n){return n.index==t._ParentCatgIndex}),Array.isArray(t._linkParentCatg)&&(t._linkParentCatg=t._linkParentCatg.length>0?t._linkParentCatg[0]:null),t._linkCatg=t._linkParentCatg?$.grep(t._linkParentCatg.subCategories,function(n){return n.index===t._CatgIndex}):$.grep(o.categories,function(n){return n.index===t._CatgIndex}),Array.isArray(t._linkCatg)&&(t._linkCatg=t._linkCatg.length>0?t._linkCatg[0]:null),t._linkTags=t._TagsIndexes&&t._TagsIndexes.length>0?$.grep(o.tags,function(n){return $.inArray(n.index,t._TagsIndexes)>=0}):[],t._linkCityDetail=$.grep(o.cityDetails,function(n){return n.index===t._CityDetailIndex}),Array.isArray(t._linkCityDetail)&&(t._linkCityDetail=t._linkCityDetail.length>0?t._linkCityDetail[0]:null),i===0)for(c in t)c.startsWith("_")||o.tableHeaders.push(c);l(t);o.csvItems.push(t);t.hasErrors=function(){return this&&s(this)}}for($.each(o.csvItems,function(n,t){s(t)&&(o.Errors=!0);t.errorMessage&&(o.CsvErrors=!0)}),a=o.csvItems.map(function(n){return n.errorMessage}),i=0;i<a.length;i++)v=a[i],v!=null&&o.errorCount++;o.showUpload=!1;o.showClear=!0;o.showTable=!0}},u=function(n){n.data&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},f=function(){toggleGlblWaitVisibility(!1)};o.errormsg="";o.csvItems.length=0;o.tableHeaders.length=0;o.errorCount=0;toggleGlblWaitVisibility(!0);n({url:"/ApiBulkImport/UploadCSV",method:"POST",data:i,headers:{"Content-Type":undefined},transformRequest:angular.identity}).then(r,u).finally(f)}};h=document.getElementById("addrCSV");h.onchange=function(){o.addrFilename=h.files[0].name;t.$$phase||t.$apply()};c=document.getElementById("timeCSV");c.onchange=function(){o.timeFilename=c.files[0].name;t.$$phase||t.$apply()};o.clearForm=function(){o.Errors=!1;o.CsvErrors=!1;o.hasSuccess=!1;o.showTable=!1;o.showClear=!1;o.showUpload=!0;o.showCatgDbValErrors=!1;o.showTagDbValErrors=!1;o.showCityDetailDbValErrors=!1;o.showPostSaveErrors=!1;o.addrFilename="";o.timeFilename="";h.value="";c.value="";o.csvItems.length=0;o.tableHeaders.length=0;o.categories.length=0;o.postSaveLogs.length=0;o.categoryErrorsCount=0;o.tagErrorsCount=0;o.cityDetailErrorsCount=0;o.errormsg=null};o.showRows=function(n){if(o.csvItems)switch(n){case"errors":$.each(o.csvItems,function(n,t){t.forceHide=s(t)?!1:!0});break;case"success":$.each(o.csvItems,function(n,t){t.forceHide=s(t)?!0:!1});break;default:$.each(o.csvItems,function(n,t){t.forceHide=!1})}};o.download=function(){$.each(o.csvItems,function(n,t){for(var u=[],f=[],e,h,r,c,i=0;i<t._linkTags.length;i++)e=t._linkTags[i],e.foundInDb===!1&&u.push(e.name);for(i=0;i<t._DaysCsv.length;i++)for(h=t._DaysCsv[i].values,r=0;r<h.length;r++)c=h[r],c.errorMessage!==null&&f.push(c.errorMessage);s(t)&&(t.errorMessage?o.log.row+=t.errorMessage+"\r\n\r\n":(t._linkParentCatg.foundInDb===!1&&(t._linkCatg.foundInDb===!1?t._linkCityDetail.foundInDb===!1?(o.log.row+="Error caught for Row "+(n+1)+":\r\n",o.log.row+="The Category '"+t._linkParentCatg.name+"' does not exist in the database.\r\n",o.log.row+="The Sub Category '"+t._linkCatg.name+"' does not exist in the database.\r\n",o.log.row+="The City '"+t._linkCityDetail.name+"' does not exist in the database.\r\n\r\n"):(o.log.row+="Error caught for Row "+(n+1)+":\r\n",o.log.row+="The Category '"+t._linkParentCatg.name+"' does not exist in the database.\r\n",o.log.row+="The Sub Category '"+t._linkCatg.name+"' does not exist in the database.\r\n\r\n"):(o.log.row+="Error caught for Row "+(n+1)+":\r\n",o.log.row+="The Category '"+t._linkParentCatg.name+"' does not exist in the database.\r\n\r\n")),u.length>0&&(o.log.row+="The Tags '"+u+"' does not exist in the database.\r\n\r\n"),f.length>0&&(o.log.row+=f)))});var n=new e([o.log.row],{type:"text/plain;charset=utf-8"});f.saveAs(n,"log.txt")};o.createCatgModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createCategoryModal.html",controller:"createCategoryInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{category:n,rootVm:o}}}})};o.createTagModal=function(n){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createTagModal.html",controller:"createTagInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{tag:n,rootVm:o}}}})};o.createCityDetailModal=function(t){var u;if(t)if(u=function(){i.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"createCityDetailModal.html",controller:"createCityDetailInstanceCtrlr",controllerAs:"vm",size:"lg",appendTo:$("#bulkimportVw .modal-container"),resolve:{param:function(){return{cityDetail:t,cityRegions:o.cityRegions,cityGroups:o.cityGroups,cityDistricts:o.cityDistricts,rootVm:o}}}})},o.cityRegions&&o.cityRegions.length>0&&o.cityDistricts&&o.cityDistricts.length>0&&o.cityGroups&&o.cityGroups.length>0)u();else{var f=function(n){n&&n.data&&(n.data.regions&&(o.cityRegions=o.cityRegions?o.cityRegions:[],$.each(n.data.regions,function(n,t){t.name=r.currentLang.startsWith("en")?t.name_en:t.name_fr;o.cityRegions.push(t)})),n.data.districts&&(o.cityDistricts=o.cityDistricts?o.cityDistricts:[],$.each(n.data.districts,function(n,t){o.cityDistricts.push(t)})),n.data.groups&&(o.cityGroups=o.cityGroups?o.cityGroups:[],$.each(n.data.groups,function(n,t){o.cityGroups.push(t)})))},e=function(n){n.data&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);u()};toggleGlblWaitVisibility(!0);n.get("/ApiBulkImport/GetRegionsDistrictsGroups").then(f,e).finally(s)}};o.addressesHaveErrors=function(n){return o.csvItems&&$.grep(o.csvItems,function(t){return s(t,n)}).length>0};o.addressesHaveSuccess=function(){return o.csvItems&&$.grep(o.csvItems,function(n){return!s(n)}).length>0};o.getErrorCount=function(){return $.grep(o.csvItems,function(n){return s(n)}).length};o.saveAddressCsvs=function(){var t;if(o.postSaveLogs.length=0,t=$.grep(o.csvItems,function(n){return!s(n)}),t.length>0){var i=function(n){var t="",i;n&&n.data&&n.data.logs&&(i=[],$.each(n.data.logs,function(n,r){o.postSaveLogs.push(r);t!=""&&(t+="\r\n\r\n");t+=r.value;var u=$.grep(o.csvItems,function(n){return n.addressUUID===r.key});u.length>0&&i.push(u[0])}),o.csvItems.length=0,$.each(i,function(n,t){t.postLogValue=t.value;t.hasPostSaveError=!0;o.csvItems.push(t)}))},r=function(n){n.data&&(o.errorstatus=n.status+" - "+n.statusText,o.errormsg=n.data.msg,o.errorid=n.data.id,o.showError=!0)},u=function(){toggleGlblWaitVisibility(!1)};toggleGlblWaitVisibility(!0);n.post("/ApiBulkImport/SaveCsvAddresses",{csvs:t}).then(i,r).finally(u)}}}function t(n,t,i,r){var u=this;u.appProps=i;u.category={name:r.category.name,slug:r.category.slug,parentUID:r.category.parentUID,parentName:r.category.parentName,name_en:r.category.name,name_fr:"",slug_en:r.category.slug,slug_fr:"",iconClass:"",id:0,parent_Id:null,level:0,path:"",active:!0,status:1,recordState:10,desc_en:"",desc_fr:""};u.save=function(){var f=!1,e=function(n){var t,u,e;if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1&&(t=n.data.result[0],r.category.uid=t.uid,r.category.foundInDb=!0,r.category.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr,r.rootVm.categoryErrorsCount--,r.category.subCategories))for(u=0;u<r.category.subCategories.length;u++)e=r.category.subCategories[u],e.parentUID=r.category.uid,e.parentName=r.category.name},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveCatgs,{catgs:[u.category]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}function i(n,t,i,r){var u=this;u.appProps=i;u.tag={name:r.tag.name,slug:r.tag.slug,name_en:r.tag.name,name_fr:"",slug_en:r.tag.slug,slug_fr:"",id:0,active:!0,status:1,recordState:10};u.save=function(){var f=!1,e=function(n){if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1){var t=n.data.result[0];r.tag.uid=t.uid;r.tag.foundInDb=!0;r.tag.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr;r.rootVm.tagErrorsCount--}},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveTags,{tags:[u.tag]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}function r(n,t,i,r){var u=this;u.appProps=i;var f=$.grep(r.cityRegions,function(n){return n.id===r.cityDetail.region_Id}),e=$.grep(r.cityDistricts,function(n){return n.id===r.cityDetail.district_Id}),o=$.grep(r.cityGroups,function(n){return n.id===r.cityDetail.group_Id});u.cityRegions=r.cityRegions;u.cityDistricts=r.cityDistricts;u.cityGroups=r.cityGroups;u.regionChanged=function(){u.cityDetail.region_Id=u.cityDetail.region?u.cityDetail.region.id:0};u.districtChanged=function(){u.cityDetail.district_Id=u.cityDetail.district?u.cityDetail.district.id:0};u.groupChanged=function(){u.cityDetail.group_Id=u.cityDetail.group?u.cityDetail.group.id:0};u.cityDetail={name:r.cityDetail.name,slug:r.cityDetail.slug,name_en:r.cityDetail.name,name_fr:"",slug_en:r.cityDetail.slug,slug_fr:"",region_Id:r.cityDetail.region_Id,region:f&&f.length>0?f[0]:null,district_Id:r.cityDetail.region_Id,district:e&&e.length>0?e[0]:null,group_Id:r.cityDetail.region_Id,group:o&&o.length>0?o[0]:null,id:0,active:!0,status:1,recordState:10};u.save=function(){var f=!1,e=function(n){if(f=!0,n.data&&n.data.result&&n.data.result.length>0&&n.data.result.length===1){var t=n.data.result[0];r.cityDetail.uid=t.uid;r.cityDetail.foundInDb=!0;r.cityDetail.name=i.currentLang.startsWith("en")?t.name_en:t.name_fr;r.cityDetail.region_Id=t.region_Id;r.cityDetail.district_Id=t.district_Id;r.cityDetail.group_Id=t.group_Id;r.rootVm.cityDetailErrorsCount--}},o=function(n){n.data&&checkRedirectForSignIn(n.data)&&(u.errorstatus=n.status+" - "+n.statusText,u.errormsg=n.data.msg,u.errorid=n.data.id,u.showError=!0)},s=function(){toggleGlblWaitVisibility(!1);f&&t.close()};u.showError=!1;u.errorstatus="";u.errormsg="";u.errorid=0;toggleGlblWaitVisibility(!0);n.post(i.urlSaveCityDetails,{cityDetails:[u.cityDetail]}).then(e,o).finally(s)};u.cancel=function(){t.close()}}angular.module("app-mainmenu").controller("bulkImportCtrlr",["$http","$scope","$uibModal","appProps","headerConfigService","FileSaver","Blob",n]);angular.module("app-mainmenu").controller("createCategoryInstanceCtrlr",["$http","$uibModalInstance","appProps","param",t]);angular.module("app-mainmenu").controller("createTagInstanceCtrlr",["$http","$uibModalInstance","appProps","param",i]);angular.module("app-mainmenu").controller("createCityDetailInstanceCtrlr",["$http","$uibModalInstance","appProps","param",r])})();